"0","add.predictor_hybrid <- function(xi_1, xi_2, alpha = 1) {"
"0","  # Safe access to is.eqbasis()"
"0","  is_eqbasis <- getFromNamespace(""is.eqbasis"", ""fda"")"
"0",""
"0","  for (i in seq_len(xi_1$n_functional)) {"
"0","    if (!is_eqbasis(xi_1$functional_list[[i]]$basis, xi_2$functional_list[[i]]$basis)) {"
"0","      stop(""Functional predictors must have the same basis."")"
"0","    }"
"0","  }"
"0","  "
"0","   # Type checks"
"0","  if (!inherits(xi_1, ""predictor_hybrid"") || !inherits(xi_2, ""predictor_hybrid"")) {"
"0","    stop(""Both inputs must be of class 'predictor_hybrid'."")"
"0","  }"
"0",""
"0","  # Structural checks"
"0","  if (xi_1$n_functional != xi_2$n_functional) {"
"0","    stop(""Mismatch in number of functional predictors."")"
"0","  }"
"0","  if (xi_1$n_scalar != xi_2$n_scalar) {"
"0","    stop(""Mismatch in number of scalar predictors."")"
"0","  }"
"0",""
"0","  # Swap so that broadcasting always applies to xi_2"
"0","  if (xi_1$n_sample == 1 && xi_2$n_sample > 1) {"
"0","    tmp <- xi_1"
"0","    xi_1 <- xi_2"
"0","    xi_2 <- tmp"
"0","  }"
"0",""
"0","  n1 <- xi_1$n_sample"
"0","  n2 <- xi_2$n_sample"
"0",""
"0","  if (!(n1 == n2 || n2 == 1)) {"
"0","    stop(""Sample sizes are incompatible for broadcasting."")"
"0","  }"
"0",""
"0","  # Prepare components"
"0","  f1 <- xi_1$functional_list"
"0","  f2 <- xi_2$functional_list"
"0","  Z1 <- xi_1$Z"
"0","  Z2 <- xi_2$Z"
"0",""
"0","  # Replicate fd and Z if needed"
"0","  if (n2 == 1) {"
"0","    f2 <- rep_fd(f2, n1)"
"0","    Z2 <- matrix(rep(c(Z2), n1), nrow = n1, byrow = TRUE)"
"0","  }"
"0",""
"0","  # Combine functional predictors"
"0","  new_functional_list <- Map("
"0","    function(f1, f2) plus.fd(f1, times.fd(alpha, f2)),"
"0","    f1,"
"0","    f2"
"0","  )"
"0"," "
"0",""
"0","  # Compute scalar inner products"
"0","  inprod_scalar <- rowSums(Z1 * Z2) "
"0","  # Combine scalar predictors"
"0","  new_Z <- Z1 + alpha * Z2"
"0",""
"0",""
"0","  # Construct new object"
"0","  predictor_hybrid(Z = new_Z, functional_list = new_functional_list)"
"0","}"
