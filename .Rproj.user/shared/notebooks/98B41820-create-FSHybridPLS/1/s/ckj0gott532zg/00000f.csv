"0","get_xi_hat_linear_pen <- function(W, y, lambda){"
"0","  # new"
"0","  ## step 1: inner products"
"0","    n <- W$n_sample"
"0","  K <- W$n_functional"
"0","  u <- gamma <- list()"
"0","  "
"0","  v <- t(W$Z) %*% y"
"0","  q <- sum(v^2)"
"0","  for (j in 1:K){"
"0","    Theta_t <- W$functional_list[[j]]$coefs"
"0","    B <- W$gram_list[[j]]"
"0","    u[[j]] <- B %*% Theta_t %*% y"
"0","    "
"0",""
"0","    # linear system"
"0","    R <- W$gram_list[[j]] + lambda[j] * W$gram_deriv2_list[[j]]"
"0","    print(R)"
"0","    U_cholesky <- chol(R)"
"0","    L_cholesky <- t(U_cholesky)"
"0","    intermediate <- forwardsolve(L_cholesky, u[[j]])"
"0","    gamma[[j]] <- backsolve(U_cholesky, intermediate)"
"0","    "
"0","     #q"
"0","    q <- q + sum( u[[j]] * gamma[[j]] )"
"0","  }"
"0","  d_vec <- c(do.call(c, gamma), v)  # or: unlist(d)"
"0","  ## step 2: squared norm"
"0","  d_vec <- d_vec/ sqrt(q)"
"0","  xi_hat <- predictor_hybrid_from_coef(format = W, coef = d_vec)"
"0","  return(xi_hat)"
"0","}"
