"0","#' @title Dataset Splitting and Normalization"
"0","#' @description "
"0","DataSplitterNormalizer <- R6::R6Class("
"0","  ""DataSplitterNormalizer"","
"0",""
"0","  public = list("
"0",""
"0","    data_original = NULL,  # Stores the original dataset"
"0","    n_sample = NULL,  # Number of samples"
"0","    train_ratio = NULL,  # Train-test split ratio"
"0","    idx_train = NULL,  # Train indices"
"0","    train=NULL,"
"0","    test=NULL,"
"0",""
"0","    #' @title Initialize Data Splitter and Normalizer"
"0","    #' @description Constructs the instance, splits the data into train and test sets."
"0","    #' Users must call `normalize_data()` separately."
"0","    #' @param data_original List. Contains `functional_predictors` (list of `fd` objects)"
"0","    #' and `scalar_predictors` (matrix)."
"0","    #' @param train_ratio Numeric. Ratio of data to use for training (e.g., 0.8)."
"0","    #' @return An instance of `DataSplitterNormalizer`."
"0","    #' @export"
"0","    initialize = function(data_original, train_ratio = 0.8) {"
"0","      self$n_sample <- length(data_original$response)"
"0","      self$train_ratio <- train_ratio"
"0","      self$data_original <- data_original"
"0",""
"0","    },"
"0",""
"0","    #' @title Split Data into Train and Test Sets"
"0","    #' @description Creates train/test indices and splits functional, scalar, and response variables."
"0","    #' @return None. Updates train and test variables."
"0","    #' @export"
"0","    split_data = function(idx_train = NULL) {"
"0","      # Use provided idx_train if available; otherwise, generate it"
"0","      if (is.null(idx_train)) {"
"0","        self$idx_train <- get_idx_train(self$n_sample, self$train_ratio)"
"0","      } else {"
"0","        self$idx_train <- idx_train"
"0","      }"
"0",""
"0",""
"0","      split_packed <- split.all("
"0","        self$data_original$functional_1,"
"0","        self$data_original$functional_2,"
"0","        self$data_original$scalar,"
"0","        self$data_original$response,"
"0","        self$idx_train"
"0","      )"
"0",""
"0","      # Assign train/test sets"
"0","      self$train <- list("
"0","        functional_1 = split_packed$data_fun_1_train,"
"0","        functional_2 = split_packed$data_fun_2_train,"
"0","        scalar = split_packed$data_scalar_train,"
"0","        response = split_packed$response_train"
"0","      )"
"0","      self$test <- list("
"0","        functional_1 = split_packed$data_fun_1_test,"
"0","        functional_2 = split_packed$data_fun_2_test,"
"0","        scalar = split_packed$data_scalar_test,"
"0","        response = split_packed$response_test"
"0","      )"
"0",""
"0",""
"0","    },"
"0",""
"0","    #' @title Normalize Train and Test Data"
"0","    #' @description Applies curve, scalar, and between-functional-scalar normalization."
"0","    #' @return None. Updates train and test sets."
"0","    #' @export"
"0","    normalize_data = function() {"
"0","      # Initialize normalizers"
"0","      normalizer_functional <- normalizer_functional_predictor$new()"
"0","      normalizer_scalar <- normalizer_scalar_predictor$new()"
"0",""
"0","      # Normalize first functional predictor"
"0","      normalizer_functional$normalize(self$train$functional_1, self$test$functional_1)"
"0","      self$train$functional_1 <- normalizer_functional$get_normalized()$train_normalized"
"0","      self$test$functional_1 <- normalizer_functional$get_normalized()$test_normalized"
"0",""
"0","      # Normalize second functional predictor"
"0","      normalizer_functional$normalize(self$train$functional_2, self$test$functional_2)"
"0","      self$train$functional_2 <- normalizer_functional$get_normalized()$train_normalized"
"0","      self$test$functional_2 <- normalizer_functional$get_normalized()$test_normalized"
"0",""
"0","      # Normalize scalar predictors"
"0","      normalizer_scalar$normalize(self$train$scalar, self$test$scalar)"
"0","      self$train$scalar <- normalizer_scalar$get_normalized()$train_normalized"
"0","      self$test$scalar<- normalizer_scalar$get_normalized()$test_normalized"
"0",""
"0","      # Apply between-functional-scalar normalization"
"0","      self$normalize_between()"
"0",""
"0","      # Normalize response variable"
"0","      self$normalize_response()"
"0","    },"
"0",""
"0","    #' @title Normalize Between Functional and Scalar Predictors"
"0","    #' @description Scales scalar predictors to ensure comparability with functional predictors."
"0","    #' @export"
"0","    normalize_between = function() {"
"0","      omega <- sum(diag(inprod(self$train$functional_1, self$train$functional_1))) +"
"0","        sum(diag(inprod(self$train$functional_2, self$train$functional_2)))"
"0",""
"0","      omega <- omega / sum(self$train$scalar^2)"
"0",""
"0","      self$train$scalar <- sqrt(omega) * self$train$scalar"
"0","      self$test$scalar <- sqrt(omega) * self$test$scalar"
"0","    },"
"0",""
"0","    #' @title Normalize Response Variable"
"0","    #' @description Centers response variable based on training mean."
"0","    #' @export"
"0","    normalize_response = function() {"
"0","      response_mean_train <- mean(self$train$response)"
"0","      self$train$response <- self$train$response - response_mean_train"
"0","      self$test$response <- self$test$response - response_mean_train"
"0","    } #must not end with ,"
"0",""
"0",""
"0","  )"
"0",")"
"0",""
"0","#' @title Generate Train Indices"
"0","#' @description Generates train/test split indices."
"0","#' @param n_sample Integer. Number of samples."
"0","#' @param train_ratio Numeric. Ratio of train samples."
"0","#' @return Vector of train indices."
"0","get_idx_train <- function(n_sample, train_ratio) {"
"0","  n_train <- floor(n_sample * train_ratio)"
"0","  idx_train <- sort(sample(n_sample, n_train, replace = FALSE))"
"0","  return(idx_train)"
"0","}"
"0",""
"0","#' @title Split Functional, Scalar, and Response Data"
"0","#' @description Splits functional predictors, scalar predictors, and response into train and test sets."
"0","#' @param data_fun_1 fd. Functional predictor 1."
"0","#' @param data_fun_2 fd. Functional predictor 2."
"0","#' @param data_scalar Matrix. Scalar predictors."
"0","#' @param response Vector. Response variable."
"0","#' @param train_idx Vector. Indices for train data."
"0","#' @return List containing split train and test sets."
"0","split.all <- function(data_fun_1, data_fun_2, data_scalar, response, train_idx) {"
"0","  return(list("
"0","    data_fun_1_train = data_fun_1[train_idx],"
"0","    data_fun_1_test = data_fun_1[-train_idx],"
"0","    data_fun_2_train = data_fun_2[train_idx],"
"0","    data_fun_2_test = data_fun_2[-train_idx],"
"0","    data_scalar_train = data_scalar[train_idx, , drop = FALSE],"
"0","    data_scalar_test = data_scalar[-train_idx, , drop = FALSE],"
"0","    response_train = response[train_idx],"
"0","    response_test = response[-train_idx]"
"0","  ))"
"0","}"
